"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.HoogleDocView = void 0;
const atom_1 = require("atom");
const etch = require("etch");
const util_1 = require("./util");
class HoogleDocView {
    constructor(props = {}) {
        this.props = props;
        this.disposables = new atom_1.CompositeDisposable();
        this.style = {};
        this.parsedDoc = '';
        this.openWebDoc = () => {
            this.props.symbol && util_1.openWeb(this.props.symbol, false);
        };
        this.updateDoc(props.symbol && props.symbol.doc);
        this.disposables.add(atom.config.observe('editor.fontSize', (fontSize) => {
            if (fontSize) {
                this.style.fontSize = `${fontSize}px`;
            }
        }), atom.config.observe('editor.fontFamily', (fontFamily) => {
            if (fontFamily) {
                this.style.fontFamily = fontFamily;
            }
        }));
        etch.initialize(this);
    }
    render() {
        let hrefBtns = [];
        if (this.props.symbol && this.props.symbol.href) {
            hrefBtns = [
                (etch.dom("a", { class: "btn btn-default", on: { click: this.openWebDoc } }, "Open web documentation")),
                (etch.dom("a", { class: "btn btn-default", href: this.props.symbol.href }, "Open web documentation in browser")),
            ];
        }
        return (etch.dom("div", { class: "ide-haskell-hoogle" },
            etch.dom("div", { style: this.style, innerHTML: util_1.hl(this.props.symbol && this.props.symbol.signature || '', true) }),
            etch.dom("div", null, hrefBtns),
            etch.dom("div", { class: "ide-haskell-hoogle-output editor editor-colors native-key-bindings", style: this.style, tabIndex: "-1", innerHTML: this.parsedDoc })));
    }
    async update(props) {
        if ((this.props.symbol && this.props.symbol.doc)
            !== (props.symbol && props.symbol.doc)) {
            this.updateDoc(props.symbol && props.symbol.doc);
        }
        this.props = props;
        return etch.update(this);
    }
    getURI() {
        return 'ide-haskell://hoogle/doc/';
    }
    getTitle() {
        return 'Hoogle doc';
    }
    destroy() {
        etch.destroy(this);
        this.disposables.dispose();
    }
    serialize() {
        return Object.assign(Object.assign({}, this.props), { deserializer: 'HoogleDocView' });
    }
    updateDoc(doc) {
        if (!doc) {
            this.parsedDoc = 'No documentation';
            return;
        }
        const div = document.createElement('div');
        div.innerHTML = doc;
        div.querySelectorAll('pre').forEach((el) => {
            el.outerHTML = util_1.hl(el.innerText, false);
        });
        div.querySelectorAll('a').forEach((el) => {
            el.outerHTML = util_1.hl(el.innerText.trim(), true);
        });
        this.parsedDoc = div.innerHTML;
    }
}
exports.HoogleDocView = HoogleDocView;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG9vZ2xlLWRvYy12aWV3LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2hvb2dsZS1kb2Mtdmlldy50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0JBQTBDO0FBQzFDLDZCQUE0QjtBQUM1QixpQ0FBb0M7QUFRcEMsTUFBYSxhQUFhO0lBT3hCLFlBQW1CLFFBQWdCLEVBQUU7UUFBbEIsVUFBSyxHQUFMLEtBQUssQ0FBYTtRQU45QixnQkFBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUN0QyxVQUFLLEdBR1QsRUFBRSxDQUFBO1FBQ0UsY0FBUyxHQUFXLEVBQUUsQ0FBQTtRQXVHdEIsZUFBVSxHQUFHLEdBQUcsRUFBRTtZQUN4QixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sSUFBSSxjQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUE7UUFDeEQsQ0FBQyxDQUFBO1FBdkdDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE1BQU0sSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQ2hELElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUNsQixJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLFFBQWdCLEVBQUUsRUFBRTtZQUMxRCxJQUFJLFFBQVEsRUFBRTtnQkFDWixJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxHQUFHLFFBQVEsSUFBSSxDQUFBO2FBQ3RDO1FBQ0gsQ0FBQyxDQUFDLEVBQ0YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxVQUFrQixFQUFFLEVBQUU7WUFDOUQsSUFBSSxVQUFVLEVBQUU7Z0JBQ2QsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFBO2FBQ25DO1FBQ0gsQ0FBQyxDQUFDLENBQ0gsQ0FBQTtRQUNE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WUFDdkMsRUFBRSxDQUFDLFNBQVMsR0FBRyxTQUFFLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUM5QyxDQUFDLENBQUMsQ0FBQTtRQUNGLElBQUksQ0FBQyxTQUFTLEdBQUcsR0FBRyxDQUFDLFNBQVMsQ0FBQTtJQUNoQyxDQUFDO0NBS0Y7QUFoSEQsc0NBZ0hDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSB9IGZyb20gJ2F0b20nXG5pbXBvcnQgKiBhcyBldGNoIGZyb20gJ2V0Y2gnXG5pbXBvcnQgeyBobCwgb3BlbldlYiB9IGZyb20gJy4vdXRpbCdcblxuZXhwb3J0IGludGVyZmFjZSBJUHJvcHMgZXh0ZW5kcyBKU1guUHJvcHMge1xuICBzeW1ib2w/OiBJU3ltYm9sXG59XG5cbnR5cGUgRWxlbWVudENsYXNzID0gSlNYLkVsZW1lbnRDbGFzc1xuXG5leHBvcnQgY2xhc3MgSG9vZ2xlRG9jVmlldyBpbXBsZW1lbnRzIEVsZW1lbnRDbGFzcyB7XG4gIHB1YmxpYyBkaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgcHJpdmF0ZSBzdHlsZToge1xuICAgIGZvbnRTaXplPzogc3RyaW5nXG4gICAgZm9udEZhbWlseT86IHN0cmluZ1xuICB9ID0ge31cbiAgcHJpdmF0ZSBwYXJzZWREb2M6IHN0cmluZyA9ICcnXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBwcm9wczogSVByb3BzID0ge30pIHtcbiAgICB0aGlzLnVwZGF0ZURvYyhwcm9wcy5zeW1ib2wgJiYgcHJvcHMuc3ltYm9sLmRvYylcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgIGF0b20uY29uZmlnLm9ic2VydmUoJ2VkaXRvci5mb250U2l6ZScsIChmb250U2l6ZTogbnVtYmVyKSA9PiB7XG4gICAgICAgIGlmIChmb250U2l6ZSkge1xuICAgICAgICAgIHRoaXMuc3R5bGUuZm9udFNpemUgPSBgJHtmb250U2l6ZX1weGBcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICBhdG9tLmNvbmZpZy5vYnNlcnZlKCdlZGl0b3IuZm9udEZhbWlseScsIChmb250RmFtaWx5OiBzdHJpbmcpID0+IHtcbiAgICAgICAgaWYgKGZvbnRGYW1pbHkpIHtcbiAgICAgICAgICB0aGlzLnN0eWxlLmZvbnRGYW1pbHkgPSBmb250RmFtaWx5XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgIClcbiAgICBldGNoLmluaXRpYWxpemUodGhpcylcbiAgfVxuXG4gIHB1YmxpYyByZW5kZXIoKSB7XG4gICAgbGV0IGhyZWZCdG5zOiBKU1guRWxlbWVudFtdID0gW11cbiAgICBpZiAodGhpcy5wcm9wcy5zeW1ib2wgJiYgdGhpcy5wcm9wcy5zeW1ib2wuaHJlZikge1xuICAgICAgaHJlZkJ0bnMgPSBbXG4gICAgICAgIChcbiAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZTpuby11bnNhZmUtYW55XG4gICAgICAgICAgPGEgY2xhc3M9XCJidG4gYnRuLWRlZmF1bHRcIiBvbj17eyBjbGljazogdGhpcy5vcGVuV2ViRG9jIH19PlxuICAgICAgICAgICAgT3BlbiB3ZWIgZG9jdW1lbnRhdGlvblxuICAgICAgICAgIDwvYT5cbiAgICAgICAgICAvLyB0c2xpbnQ6ZW5hYmxlOm5vLXVuc2FmZS1hbnlcbiAgICAgICAgKSxcbiAgICAgICAgKFxuICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlOm5vLXVuc2FmZS1hbnlcbiAgICAgICAgICA8YSBjbGFzcz1cImJ0biBidG4tZGVmYXVsdFwiIGhyZWY9e3RoaXMucHJvcHMuc3ltYm9sLmhyZWZ9PlxuICAgICAgICAgICAgT3BlbiB3ZWIgZG9jdW1lbnRhdGlvbiBpbiBicm93c2VyXG4gICAgICAgICAgPC9hPlxuICAgICAgICAgIC8vIHRzbGludDplbmFibGU6bm8tdW5zYWZlLWFueVxuICAgICAgICApLFxuICAgICAgXVxuICAgIH1cbiAgICByZXR1cm4gKFxuICAgICAgLy8gdHNsaW50OmRpc2FibGU6bm8tdW5zYWZlLWFueVxuICAgICAgPGRpdiBjbGFzcz1cImlkZS1oYXNrZWxsLWhvb2dsZVwiPlxuICAgICAgICA8ZGl2XG4gICAgICAgICAgc3R5bGU9e3RoaXMuc3R5bGV9XG4gICAgICAgICAgaW5uZXJIVE1MPXtobCh0aGlzLnByb3BzLnN5bWJvbCAmJiB0aGlzLnByb3BzLnN5bWJvbC5zaWduYXR1cmUgfHwgJycsIHRydWUpfVxuICAgICAgICAvPlxuICAgICAgICA8ZGl2PntocmVmQnRuc308L2Rpdj5cbiAgICAgICAgPGRpdlxuICAgICAgICAgIGNsYXNzPVwiaWRlLWhhc2tlbGwtaG9vZ2xlLW91dHB1dCBlZGl0b3IgZWRpdG9yLWNvbG9ycyBuYXRpdmUta2V5LWJpbmRpbmdzXCJcbiAgICAgICAgICBzdHlsZT17dGhpcy5zdHlsZX1cbiAgICAgICAgICB0YWJJbmRleD1cIi0xXCJcbiAgICAgICAgICBpbm5lckhUTUw9e3RoaXMucGFyc2VkRG9jfVxuICAgICAgICAvPlxuICAgICAgPC9kaXY+XG4gICAgICAvLyB0c2xpbnQ6ZW5hYmxlOm5vLXVuc2FmZS1hbnlcbiAgICApXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBkYXRlKHByb3BzOiBJUHJvcHMpIHtcbiAgICBpZiAoKHRoaXMucHJvcHMuc3ltYm9sICYmIHRoaXMucHJvcHMuc3ltYm9sLmRvYylcbiAgICAgICE9PSAocHJvcHMuc3ltYm9sICYmIHByb3BzLnN5bWJvbC5kb2MpKSB7XG4gICAgICB0aGlzLnVwZGF0ZURvYyhwcm9wcy5zeW1ib2wgJiYgcHJvcHMuc3ltYm9sLmRvYylcbiAgICB9XG4gICAgdGhpcy5wcm9wcyA9IHByb3BzXG4gICAgcmV0dXJuIGV0Y2gudXBkYXRlKHRoaXMpXG4gIH1cblxuICBwdWJsaWMgZ2V0VVJJKCkge1xuICAgIHJldHVybiAnaWRlLWhhc2tlbGw6Ly9ob29nbGUvZG9jLydcbiAgfVxuXG4gIHB1YmxpYyBnZXRUaXRsZSgpIHtcbiAgICByZXR1cm4gJ0hvb2dsZSBkb2MnXG4gIH1cblxuICBwdWJsaWMgZGVzdHJveSgpIHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICBldGNoLmRlc3Ryb3kodGhpcylcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICB9XG5cbiAgcHVibGljIHNlcmlhbGl6ZSgpOiBJUHJvcHMgJiB7IGRlc2VyaWFsaXplcjogc3RyaW5nIH0ge1xuICAgIHJldHVybiB7XG4gICAgICAuLi50aGlzLnByb3BzLFxuICAgICAgZGVzZXJpYWxpemVyOiAnSG9vZ2xlRG9jVmlldycsXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVEb2MoZG9jOiBzdHJpbmcgfCB1bmRlZmluZWQpIHtcbiAgICBpZiAoIWRvYykge1xuICAgICAgdGhpcy5wYXJzZWREb2MgPSAnTm8gZG9jdW1lbnRhdGlvbidcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICAgIGRpdi5pbm5lckhUTUwgPSBkb2NcbiAgICBkaXYucXVlcnlTZWxlY3RvckFsbCgncHJlJykuZm9yRWFjaCgoZWwpID0+IHtcbiAgICAgIGVsLm91dGVySFRNTCA9IGhsKGVsLmlubmVyVGV4dCwgZmFsc2UpXG4gICAgfSlcbiAgICBkaXYucXVlcnlTZWxlY3RvckFsbCgnYScpLmZvckVhY2goKGVsKSA9PiB7XG4gICAgICBlbC5vdXRlckhUTUwgPSBobChlbC5pbm5lclRleHQudHJpbSgpLCB0cnVlKVxuICAgIH0pXG4gICAgdGhpcy5wYXJzZWREb2MgPSBkaXYuaW5uZXJIVE1MXG4gIH1cblxuICBwcml2YXRlIG9wZW5XZWJEb2MgPSAoKSA9PiB7XG4gICAgdGhpcy5wcm9wcy5zeW1ib2wgJiYgb3BlbldlYih0aGlzLnByb3BzLnN5bWJvbCwgZmFsc2UpXG4gIH1cbn1cbiJdfQ==